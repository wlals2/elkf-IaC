filter {
  ##################################################################
  # 0) 원문 정규화: event.original → message (Beat 8.x 대응)
  ##################################################################
  if ![message] and [event][original] {
    mutate { add_field => { "message" => "%{[event][original]}" } }
  }
  # CR 제거
  mutate { gsub => ["message", "\r$", ""] }

  # app 루트 필드 보정(필요 시)
  if ![app] and [fields][app] {
    mutate { add_field => { "app" => "%{[fields][app]}" } }
  }

  ##################################################################
  # 1) 탭 기반 라인 → Dissect로 ‘자리수 고정’ 파싱
  #    o 라인: 15칸(금액 포함), 그 외: 14칸(금액 없음)
  ##################################################################
  if [message] =~ /\t/ {
    if [message] =~ /^\s*o[\t ]/ {
      dissect {
        mapping => {
          "message" => "%{event_code}\t%{event_created}\t%{url_path}\t%{http_method}\t%{[order][id]}\t%{[order][tx_id]}\t%{[order][item_id]}\t%{[order][quantity]}\t%{col9}\t%{col10}\t%{[order][amount]}\t%{[client][ip]}\t%{[user_agent][original]}\t%{referrer_raw}\t%{status_code}"
        }
        tag_on_failure => ["_dissect_o_tab15_fail"]
      }
      mutate { add_tag => ["o_tab15"] }
    } else {
      dissect {
        mapping => {
          "message" => "%{event_code}\t%{event_created}\t%{url_path}\t%{http_method}\t%{[order][id]}\t%{[order][tx_id]}\t%{[order][item_id]}\t%{[order][quantity]}\t%{col9}\t%{col10}\t%{[client][ip]}\t%{[user_agent][original]}\t%{referrer_raw}\t%{status_code}"
        }
        tag_on_failure => ["_dissect_tab14_fail"]
      }
      mutate { add_tag => ["x_tab14"] }
    }
  } else {
    ################################################################
    # 2) 폴백: 공백 기반 라인 → GROK (15/14 토큰)
    ################################################################
    grok {
      match => {
        "message" => [
          '^(?<event_code>\w)\s+(?<event_created>\S+)\s+(?<url_path>\S+)\s+(?<http_method>\w+)\s+(?<order_id>\d+)\s+(?<order_tx_id>\S+)\s+(?<order_item_id>\d+)\s+(?<order_quantity>\d+)\s+(?<col9>\S+)\s+(?<col10>\S+)\s+(?<order_amount>\d+)\s+(?<client_ip>\S+)\s+(?<ua>.+?)\s+(?<referrer_raw>\S+)\s+(?<status_code>\d{3})$',
          '^(?<event_code>\w)\s+(?<event_created>\S+)\s+(?<url_path>\S+)\s+(?<http_method>\w+)\s+(?<order_id>\d+)\s+(?<order_tx_id>\S+)\s+(?<order_item_id>\d+)\s+(?<order_quantity>\d+)\s+(?<col9>\S+)\s+(?<col10>\S+)\s+(?<client_ip>\S+)\s+(?<ua>.+?)\s+(?<referrer_raw>\S+)\s+(?<status_code>\d{3})$'
        ]
      }
      tag_on_failure => ["_grok_fail"]
    }
    if [order_amount] {
      mutate {
        add_field => {
          "[order][id]"       => "%{order_id}"
          "[order][tx_id]"    => "%{order_tx_id}"
          "[order][item_id]"  => "%{order_item_id}"
          "[order][quantity]" => "%{order_quantity}"
          "[order][amount]"   => "%{order_amount}"
          "[client][ip]"      => "%{client_ip}"
          "[user_agent][original]" => "%{ua}"
        }
        remove_field => ["order_id","order_tx_id","order_item_id","order_quantity","order_amount","client_ip","ua"]
      }
      mutate { add_tag => ["o_space15"] }
    } else {
      mutate {
        add_field => {
          "[order][id]"       => "%{order_id}"
          "[order][tx_id]"    => "%{order_tx_id}"
          "[order][item_id]"  => "%{order_item_id}"
          "[order][quantity]" => "%{order_quantity}"
          "[client][ip]"      => "%{client_ip}"
          "[user_agent][original]" => "%{ua}"
        }
        remove_field => ["order_id","order_tx_id","order_item_id","order_quantity","client_ip","ua"]
      }
      mutate { add_tag => ["x_space14"] }
    }
  }

  ##################################################################
  # 3) 공통 매핑/정리/형변환
  ##################################################################
  mutate {
    rename => {
      "url_path"    => "[url][path]"
      "http_method" => "[http][request][method]"
    }
    gsub => [
      "referrer_raw","^(?:-|null)$","",
      "col9","^(?:-|null)$","",
      "col10","^(?:-|null)$",""
    ]
    convert => {
      "[order][id]"       => "integer"
      "[order][item_id]"  => "integer"
      "[order][quantity]" => "integer"
      "[order][amount]"   => "integer"
      "status_code"       => "integer"
    }
  }

  if [referrer_raw] and [referrer_raw] != "" {
    mutate { add_field => { "[http][request][referrer]" => "%{referrer_raw}" } }
  }

  # 날짜 → @timestamp
  date {
    match  => ["event_created","ISO8601","yyyy-MM-dd'T'HH:mm:ss.SSSSSS","yyyy-MM-dd'T'HH:mm:ss.SSSSSSSSS","yyyy-MM-dd'T'HH:mm:ssZ"]
    target => "@timestamp"
  }
  mutate { remove_field => ["event_created"] }

  # UA 파싱
  useragent { source => "[user_agent][original]" target => "user_agent" }

  # event.category/response.status_code
  mutate { lowercase => ["event_code"] }
  translate {
    source   => "event_code"
    target   => "[event][category]"
    override => true
    dictionary => { "c" => "cart" "o" => "order" "l" => "list" "v" => "view" }
    fallback => "other"
  }
  if [status_code] {
    mutate { add_field => { "[http][response][status_code]" => "%{status_code}" } }
    mutate { convert   => { "[http][response][status_code]" => "integer" } }
  }

  # 군더더기 제거
  mutate { remove_field => ["message","referrer_raw","col9","col10","status_code"] }
}
